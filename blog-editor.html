<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ブログ記事エディタ | 木村紀喜</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Outfit:wght@400;600&display=swap">
    <style>
        :root {
            --main-enji: #8B1538;
            --enji-dark: #6B0F2A;
            --enji-light: rgba(139, 21, 56, 0.06);
            --off-white: #FAF8F6;
            --primary-text: #1A1A1A;
            --secondary-text: #555;
            --border-light: #E8E4E0;
            --green: #27ae60;
            --blue: #3498db;
            --orange: #e67e22;
            --red: #e74c3c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Noto Sans JP", sans-serif;
            background: var(--off-white);
            color: var(--primary-text);
            line-height: 1.7;
        }

        /* ===== Login Screen ===== */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1A1A1A 0%, #2c1a23 100%);
        }
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 48px 40px;
            max-width: 480px;
            width: 90%;
            text-align: center;
        }
        .login-card h1 {
            font-size: 1.4rem;
            margin-bottom: 4px;
            color: var(--primary-text);
        }
        .login-card .login-sub {
            font-size: 0.85rem;
            color: var(--secondary-text);
            margin-bottom: 32px;
        }
        .login-card .github-icon {
            width: 48px; height: 48px; margin-bottom: 20px;
        }
        .login-field {
            text-align: left;
            margin-bottom: 20px;
        }
        .login-field label {
            display: block;
            font-weight: 700;
            font-size: 0.82rem;
            color: var(--secondary-text);
            margin-bottom: 6px;
        }
        .login-field input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border-light);
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.92rem;
            transition: border-color 0.2s;
        }
        .login-field input:focus {
            outline: none;
            border-color: var(--main-enji);
        }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary-text);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }
        .login-btn:hover { background: #333; transform: translateY(-1px); }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .login-error {
            background: #fdecea;
            color: #b71c1c;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.84rem;
            margin-top: 16px;
            display: none;
        }
        .login-error.show { display: block; }
        .login-error { white-space: pre-line; line-height: 1.7; }
        .login-help {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
            text-align: left;
            font-size: 0.8rem;
            color: var(--secondary-text);
            line-height: 1.9;
        }
        .login-help summary {
            cursor: pointer;
            font-weight: 700;
            color: var(--main-enji);
            font-size: 0.84rem;
            margin-bottom: 8px;
        }
        .login-help code {
            background: rgba(139,21,56,0.08);
            color: var(--enji-dark);
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.78rem;
        }
        .login-help a {
            color: var(--main-enji);
        }

        /* ===== Editor (hidden until login) ===== */
        .editor-screen { display: none; }
        .editor-screen.active { display: block; }
        .login-screen.hidden { display: none; }

        /* Header */
        .editor-header {
            background: var(--primary-text);
            color: white;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .editor-header h1 { font-size: 1.05rem; font-weight: 700; letter-spacing: 0.04em; }
        .editor-header .subtitle { font-size: 0.78rem; opacity: 0.55; margin-top: 2px; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .header-user {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-right: 8px;
        }
        .btn-header {
            padding: 8px 18px;
            font-size: 0.82rem;
            border-radius: 6px;
            border: 1.5px solid rgba(255,255,255,0.3);
            background: transparent;
            color: white;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-header:hover {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.5);
        }
        .btn-header:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-header.saving {
            background: var(--green);
            border-color: var(--green);
        }
        .btn-header.error-state {
            background: var(--red);
            border-color: var(--red);
        }

        /* Connection status */
        .conn-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
        }
        .conn-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--green);
        }
        .conn-dot.offline { background: var(--red); }

        /* Layout */
        .editor-layout {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }
        .panel {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border-light);
            overflow: hidden;
        }
        .panel-header {
            background: var(--enji-light);
            padding: 14px 24px;
            font-weight: 700;
            font-size: 0.92rem;
            color: var(--main-enji);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .panel-body { padding: 24px; }

        /* Info banner */
        .info-banner {
            background: #FFFBF0;
            border: 1px solid #F0E6C8;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 20px;
            font-size: 0.84rem;
            color: #7A6B3A;
            line-height: 1.8;
        }
        .info-banner strong { color: #5C4F2A; }
        .info-banner.github-connected {
            background: #e8f8f0;
            border-color: #b2dfdb;
            color: #1b5e20;
        }
        .info-banner.github-connected strong { color: #1b5e20; }

        /* Form */
        .form-group { margin-bottom: 18px; }
        .form-group label {
            display: block;
            font-weight: 700;
            font-size: 0.82rem;
            margin-bottom: 5px;
            color: var(--secondary-text);
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid var(--border-light);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.2s;
            background: white;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--main-enji);
        }
        .form-group textarea {
            min-height: 110px;
            resize: vertical;
            line-height: 1.8;
        }
        .form-group select { cursor: pointer; }

        /* Category preview */
        .cat-preview {
            display: inline-block;
            font-size: 0.68rem;
            padding: 2px 9px;
            border-radius: 4px;
            color: #fff;
            margin-left: 8px;
            vertical-align: middle;
        }
        .cat-preview.notice { background: var(--orange); }
        .cat-preview.activity { background: var(--blue); }
        .cat-preview.thought { background: var(--green); }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 11px 22px;
            border-radius: 8px;
            border: none;
            font-family: inherit;
            font-size: 0.88rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--main-enji); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--enji-dark); transform: translateY(-1px); }
        .btn-secondary { background: white; color: var(--main-enji); border: 1.5px solid var(--main-enji); }
        .btn-secondary:hover:not(:disabled) { background: var(--enji-light); }
        .btn-success { background: var(--green); color: white; }
        .btn-success:hover:not(:disabled) { background: #219a52; }
        .btn-danger { background: var(--red); color: white; }
        .btn-danger:hover:not(:disabled) { background: #c0392b; }
        .btn-sm { padding: 8px 16px; font-size: 0.8rem; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }

        /* Article list */
        .article-list { margin-top: 12px; }
        .article-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 14px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 7px;
            background: var(--off-white);
            transition: all 0.15s;
        }
        .article-entry:hover { border-color: var(--main-enji); background: white; }
        .article-entry.selected { border-color: var(--main-enji); background: var(--enji-light); }
        .entry-cat {
            font-size: 0.62rem;
            padding: 2px 7px;
            border-radius: 3px;
            color: white;
            white-space: nowrap;
        }
        .entry-date {
            font-family: "Outfit", sans-serif;
            font-size: 0.78rem;
            color: #888;
            min-width: 78px;
        }
        .entry-title { flex: 1; font-size: 0.85rem; font-weight: 500; }
        .entry-actions { display: flex; gap: 3px; }
        .entry-btn {
            padding: 3px 9px;
            border: none;
            border-radius: 4px;
            font-size: 0.72rem;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: opacity 0.15s;
        }
        .entry-btn:hover { opacity: 0.85; }
        .entry-btn.edit { background: var(--blue); color: white; }
        .entry-btn.delete { background: var(--red); color: white; }
        .entry-btn.up, .entry-btn.down { background: #ddd; color: #333; }

        /* Output / preview */
        .output-area {
            background: #1e1e2e;
            color: #cdd6f4;
            border-radius: 10px;
            padding: 18px;
            font-family: "Courier New", monospace;
            font-size: 0.74rem;
            line-height: 1.45;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 460px;
            overflow-y: auto;
        }

        /* Status */
        .status-msg {
            padding: 10px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.83rem;
            font-weight: 500;
            display: none;
        }
        .status-msg.show { display: block; }
        .status-msg.success { background: #d5f5e3; color: #1a7a3a; }
        .status-msg.info { background: #d6eaf8; color: #1a5276; }
        .status-msg.error {
            background: #fdecea;
            color: #b71c1c;
            white-space: pre-line;
            line-height: 1.7;
        }

        .article-count {
            display: inline-block;
            background: var(--main-enji);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: auto;
        }

        /* Unsaved indicator */
        .unsaved-badge {
            display: none;
            background: var(--orange);
            color: white;
            font-size: 0.68rem;
            padding: 2px 10px;
            border-radius: 10px;
            font-weight: 700;
            margin-left: 10px;
        }
        .unsaved-badge.show { display: inline-block; }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 900px) {
            .editor-layout {
                grid-template-columns: 1fr;
                padding: 16px;
                gap: 20px;
            }
            .editor-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
                padding: 14px 20px;
            }
            .header-actions { width: 100%; flex-wrap: wrap; }
        }
    </style>
</head>
<body>

<!-- ===== LOGIN SCREEN ===== -->
<div class="login-screen" id="loginScreen">
    <div class="login-card">
        <svg class="github-icon" viewBox="0 0 24 24" fill="#1A1A1A"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
        <h1>ブログエディタにログイン</h1>
        <p class="login-sub">GitHub Personal Access Token で認証します</p>

        <div class="login-field">
            <label>リポジトリ オーナー / リポジトリ名</label>
            <input type="text" id="loginRepo" value="kimutoshiki/kimutoshiki" placeholder="owner/repo">
        </div>

        <div class="login-field">
            <label>Personal Access Token</label>
            <input type="password" id="loginToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
        </div>

        <div class="login-field">
            <label>ブランチ（任意・デフォルト: main）</label>
            <input type="text" id="loginBranch" value="main" placeholder="main">
        </div>

        <button class="login-btn" id="loginBtn">ログインして blog.html を読み込む</button>

        <div class="login-error" id="loginError"></div>

        <div class="login-help">
            <details>
                <summary>Personal Access Token の取得方法</summary>
                <ol style="padding-left: 20px; margin-top: 8px;">
                    <li><a href="https://github.com/settings/tokens?type=beta" target="_blank" rel="noopener">GitHub &rarr; Settings &rarr; Developer settings &rarr; Personal access tokens &rarr; Fine-grained tokens</a> を開く</li>
                    <li>「Generate new token」をクリック</li>
                    <li>Token name: 任意（例: <code>blog-editor</code>）</li>
                    <li>Expiration: 任意の期限を設定</li>
                    <li>Repository access: 「Only select repositories」で対象リポジトリを選択</li>
                    <li>Permissions &rarr; Repository permissions &rarr; <strong>Contents</strong> を <code>Read and write</code> に設定<br>
                        <span style="color:#c0392b;font-weight:700;">※ 「Read」だけでは保存できません。必ず「Read and write」を選んでください</span></li>
                    <li>「Generate token」をクリックし、表示されたトークンをコピー</li>
                </ol>
                <p style="margin-top: 10px; font-size: 0.78rem; color: #999;">
                    ※ トークンはこのブラウザのセッション内のみに保存され、タブを閉じると消去されます。<br>
                    ※ サーバーには一切送信されません。GitHub API との直接通信のみです。
                </p>
            </details>
        </div>
    </div>
</div>

<!-- ===== EDITOR SCREEN ===== -->
<div class="editor-screen" id="editorScreen">
    <div class="editor-header">
        <div>
            <h1>ブログ記事エディタ <span class="unsaved-badge" id="unsavedBadge">未保存の変更あり</span></h1>
            <div class="subtitle">GitHub リポジトリに直接保存できます</div>
        </div>
        <div class="header-actions">
            <div class="conn-status">
                <span class="conn-dot" id="connDot"></span>
                <span id="connLabel">接続中</span>
            </div>
            <span class="header-user" id="headerUser"></span>
            <button class="btn-header" id="saveToGitHubBtn" disabled>GitHub に保存</button>
            <button class="btn-header" id="reloadBtn">再読み込み</button>
            <button class="btn-header" id="logoutBtn">ログアウト</button>
        </div>
    </div>

    <div class="editor-layout">
        <!-- Left: Form & List -->
        <div>
            <div class="panel">
                <div class="panel-header">&#x270D;&#xFE0F; 記事の作成・編集</div>
                <div class="panel-body">
                    <div class="info-banner github-connected" id="infoBanner">
                        <strong>GitHub 接続済み</strong> &mdash; 記事を追加・編集後「<strong>GitHubに保存</strong>」で直接コミットされます。
                    </div>

                    <div class="form-group">
                        <label>日付（YYYY.MM.DD形式）</label>
                        <input type="text" id="articleDate" placeholder="2026.02.16">
                    </div>
                    <div class="form-group">
                        <label>カテゴリ <span class="cat-preview notice" id="catPreview">お知らせ</span></label>
                        <select id="articleCategory">
                            <option value="notice">お知らせ</option>
                            <option value="activity">活動</option>
                            <option value="thought">思考</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>タイトル</label>
                        <input type="text" id="articleTitle" placeholder="記事のタイトルを入力">
                    </div>
                    <div class="form-group">
                        <label>本文（HTML可・空欄OK）</label>
                        <textarea id="articleContent" placeholder="記事の本文を入力（空欄でもOK）&#10;&#10;HTMLタグも使えます：&#10;&lt;p&gt;段落&lt;/p&gt;&#10;&lt;a href=&quot;URL&quot;&gt;リンク&lt;/a&gt;"></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" id="addBtn">+ 記事を追加</button>
                        <button class="btn btn-success" id="updateBtn" style="display:none;">&#x2714; 更新する</button>
                        <button class="btn btn-secondary" id="cancelBtn" style="display:none;">キャンセル</button>
                    </div>
                    <div class="status-msg" id="formStatus"></div>
                </div>
            </div>

            <div class="panel" style="margin-top: 24px;">
                <div class="panel-header">
                    &#x1F4CB; 記事一覧
                    <span class="article-count" id="articleCount">0件</span>
                </div>
                <div class="panel-body">
                    <div class="article-list" id="articleList"></div>
                </div>
            </div>
        </div>

        <!-- Right: Preview & Save -->
        <div>
            <div class="panel" style="position: sticky; top: 72px; align-self: start;">
                <div class="panel-header">&#x1F4BB; 生成 HTML プレビュー</div>
                <div class="panel-body">
                    <p style="font-size: 0.82rem; color: var(--secondary-text); margin-bottom: 14px;">
                        「<strong>GitHubに保存</strong>」ボタンで、下記の内容が直接 <code style="background:rgba(139,21,56,0.08);padding:1px 5px;border-radius:3px;color:var(--enji-dark);font-size:0.8rem;">blog.html</code> にコミットされます。
                    </p>
                    <div class="btn-group" style="margin-top:0;margin-bottom:14px;">
                        <button class="btn btn-primary btn-sm" id="saveBtn2">GitHub に保存</button>
                        <button class="btn btn-secondary btn-sm" id="copyBtn">&#x1F4CB; HTMLをコピー</button>
                        <button class="btn btn-secondary btn-sm" id="dlBtn">&#x1F4E5; ダウンロード</button>
                    </div>
                    <div class="output-area" id="outputArea"><!-- プレビュー --></div>
                    <div class="status-msg" id="saveStatus"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    // ===== GitHub API Config =====
    let ghToken = '';
    let ghOwner = '';
    let ghRepo = '';
    let ghBranch = 'main';
    let ghFileSha = '';  // needed for update
    let ghUser = '';

    // ===== Article State =====
    let articles = [];
    let editingIndex = -1;
    let hasUnsavedChanges = false;

    // Category maps
    const catLabels  = { notice: 'お知らせ', activity: '活動', thought: '思考' };
    const catClasses = { notice: 'cat-notice', activity: 'cat-activity', thought: 'cat-thought' };
    const catColors  = { notice: '#e67e22', activity: '#3498db', thought: '#27ae60' };

    // ===== DOM References =====
    const $ = id => document.getElementById(id);

    // Login
    const loginScreen = $('loginScreen');
    const editorScreen = $('editorScreen');
    const loginBtn = $('loginBtn');
    const loginError = $('loginError');
    const loginToken = $('loginToken');
    const loginRepo = $('loginRepo');
    const loginBranch = $('loginBranch');

    // Editor header
    const saveToGitHubBtn = $('saveToGitHubBtn');
    const reloadBtn = $('reloadBtn');
    const logoutBtn = $('logoutBtn');
    const headerUser = $('headerUser');
    const connDot = $('connDot');
    const connLabel = $('connLabel');
    const unsavedBadge = $('unsavedBadge');

    // Form
    const dateInput = $('articleDate');
    const categorySelect = $('articleCategory');
    const titleInput = $('articleTitle');
    const contentInput = $('articleContent');
    const catPreview = $('catPreview');
    const addBtn = $('addBtn');
    const updateBtn = $('updateBtn');
    const cancelBtn = $('cancelBtn');
    const formStatus = $('formStatus');
    const articleList = $('articleList');
    const articleCount = $('articleCount');

    // Output
    const outputArea = $('outputArea');
    const saveBtn2 = $('saveBtn2');
    const copyBtn = $('copyBtn');
    const dlBtn = $('dlBtn');
    const saveStatus = $('saveStatus');

    // Set today's date
    const now = new Date();
    dateInput.value = now.getFullYear() + '.' +
        String(now.getMonth() + 1).padStart(2, '0') + '.' +
        String(now.getDate()).padStart(2, '0');

    // ===== Restore session =====
    (function restoreSession() {
        const saved = sessionStorage.getItem('blog_editor_session');
        if (saved) {
            try {
                const s = JSON.parse(saved);
                ghToken = s.token;
                ghOwner = s.owner;
                ghRepo = s.repo;
                ghBranch = s.branch;
                ghUser = s.user || '';
                loginRepo.value = s.owner + '/' + s.repo;
                loginBranch.value = s.branch;
                // Auto-login
                performLogin(true);
            } catch(e) {
                sessionStorage.removeItem('blog_editor_session');
            }
        }
    })();

    // ===== LOGIN =====
    loginBtn.addEventListener('click', () => performLogin(false));
    loginToken.addEventListener('keydown', e => { if (e.key === 'Enter') performLogin(false); });

    async function performLogin(isRestore) {
        const repoParts = loginRepo.value.trim().split('/');
        if (repoParts.length !== 2 || !repoParts[0] || !repoParts[1]) {
            showLoginError('リポジトリは「owner/repo」の形式で入力してください');
            return;
        }
        ghOwner = repoParts[0];
        ghRepo = repoParts[1];
        ghBranch = loginBranch.value.trim() || 'main';

        if (!isRestore) {
            ghToken = loginToken.value.trim();
            if (!ghToken) {
                showLoginError('Personal Access Token を入力してください');
                return;
            }
        }

        loginBtn.disabled = true;
        loginBtn.textContent = '接続中...';
        loginError.classList.remove('show');

        try {
            // Verify token: get user
            const userRes = await ghFetch('https://api.github.com/user');
            if (!userRes.ok) throw new Error('トークンが無効です（' + userRes.status + '）');
            const userData = await userRes.json();
            ghUser = userData.login;

            // Check write permission by checking repo push access
            const repoRes = await ghFetch('https://api.github.com/repos/' + ghOwner + '/' + ghRepo);
            if (!repoRes.ok) {
                if (repoRes.status === 404) throw new Error('リポジトリ ' + ghOwner + '/' + ghRepo + ' が見つかりません。リポジトリ名を確認してください。');
                throw new Error('リポジトリ情報の取得に失敗しました（' + repoRes.status + '）');
            }
            const repoData = await repoRes.json();
            if (!repoData.permissions || !repoData.permissions.push) {
                throw new Error('このトークンにはリポジトリへの書き込み権限がありません。\nトークンの Permissions → Contents を「Read and write」に設定してください。');
            }

            // Fetch blog.html
            await fetchBlogFromGitHub();

            // Save session
            sessionStorage.setItem('blog_editor_session', JSON.stringify({
                token: ghToken, owner: ghOwner, repo: ghRepo, branch: ghBranch, user: ghUser
            }));

            // Show editor
            loginScreen.classList.add('hidden');
            editorScreen.classList.add('active');
            headerUser.textContent = ghUser;
            connDot.classList.remove('offline');
            connLabel.textContent = ghOwner + '/' + ghRepo;
            saveToGitHubBtn.disabled = false;

            render();

        } catch(e) {
            showLoginError(e.message);
            if (!isRestore) {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ログインして blog.html を読み込む';
            } else {
                // Restore failed, clear session
                sessionStorage.removeItem('blog_editor_session');
                loginBtn.disabled = false;
                loginBtn.textContent = 'ログインして blog.html を読み込む';
            }
        }
    }

    function showLoginError(msg) {
        loginError.textContent = msg;
        loginError.classList.add('show');
        loginBtn.disabled = false;
        loginBtn.textContent = 'ログインして blog.html を読み込む';
    }

    // ===== GITHUB API =====
    function ghFetch(url, options = {}) {
        return fetch(url, {
            ...options,
            headers: {
                'Authorization': 'Bearer ' + ghToken,
                'Accept': 'application/vnd.github.v3+json',
                'X-GitHub-Api-Version': '2022-11-28',
                ...(options.headers || {})
            }
        });
    }

    async function fetchBlogFromGitHub() {
        const url = 'https://api.github.com/repos/' + ghOwner + '/' + ghRepo + '/contents/blog.html?ref=' + ghBranch;
        const res = await ghFetch(url);
        if (!res.ok) {
            if (res.status === 404) throw new Error('blog.html が見つかりません（ブランチ: ' + ghBranch + '）');
            throw new Error('blog.html の取得に失敗しました（' + res.status + '）');
        }
        const data = await res.json();
        ghFileSha = data.sha;

        // Decode base64 content
        const content = decodeBase64UTF8(data.content);
        parseExistingBlog(content);
        hasUnsavedChanges = false;
        updateUnsavedBadge();
    }

    async function saveBlogToGitHub() {
        const html = generateFullHTML();
        const encoded = encodeBase64UTF8(html);
        const url = 'https://api.github.com/repos/' + ghOwner + '/' + ghRepo + '/contents/blog.html';

        const commitMsg = 'update: blog.html (' + articles.length + ' articles) via blog editor';

        // First, get the latest SHA to avoid conflicts
        try {
            const latestRes = await ghFetch(url + '?ref=' + ghBranch);
            if (latestRes.ok) {
                const latestData = await latestRes.json();
                ghFileSha = latestData.sha;
            }
        } catch(e) {
            // Continue with existing SHA
        }

        const res = await ghFetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: commitMsg,
                content: encoded,
                sha: ghFileSha,
                branch: ghBranch
            })
        });

        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            const errMsg = err.message || '';
            
            if (res.status === 403 || errMsg.includes('Resource not accessible')) {
                throw new Error(
                    '権限エラー: トークンに書き込み権限がありません。\n\n' +
                    '【解決方法】\n' +
                    'Fine-grained token の場合:\n' +
                    '  GitHub → Settings → Developer settings → Personal access tokens → 該当トークン\n' +
                    '  → Permissions → Repository permissions → Contents を「Read and write」に変更\n\n' +
                    'Classic token の場合:\n' +
                    '  GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)\n' +
                    '  → 該当トークン → 「repo」にチェックを入れる'
                );
            }
            if (res.status === 409) {
                throw new Error('競合エラー: 他の場所で blog.html が更新されています。「再読み込み」後にもう一度お試しください。');
            }
            if (res.status === 422) {
                throw new Error('SHA不一致: ファイルが別の場所で更新された可能性があります。「再読み込み」してからもう一度保存してください。');
            }
            throw new Error('保存に失敗しました（' + res.status + '）: ' + errMsg);
        }

        const result = await res.json();
        ghFileSha = result.content.sha;
        hasUnsavedChanges = false;
        updateUnsavedBadge();
    }

    // Base64 encode/decode for UTF-8
    function decodeBase64UTF8(base64) {
        const raw = atob(base64.replace(/\n/g, ''));
        const bytes = new Uint8Array(raw.length);
        for (let i = 0; i < raw.length; i++) bytes[i] = raw.charCodeAt(i);
        return new TextDecoder('utf-8').decode(bytes);
    }

    function encodeBase64UTF8(str) {
        const bytes = new TextEncoder().encode(str);
        let binary = '';
        for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
        return btoa(binary);
    }

    // ===== HEADER ACTIONS =====
    saveToGitHubBtn.addEventListener('click', doSave);
    saveBtn2.addEventListener('click', doSave);

    async function doSave() {
        saveToGitHubBtn.disabled = true;
        saveToGitHubBtn.innerHTML = '<span class="spinner"></span>保存中...';
        saveToGitHubBtn.classList.remove('error-state');
        saveToGitHubBtn.classList.add('saving');

        try {
            await saveBlogToGitHub();
            saveToGitHubBtn.innerHTML = '&#x2714; 保存しました';
            showStatus(saveStatus, 'GitHub に保存しました（コミット完了）', 'success');
            setTimeout(() => {
                saveToGitHubBtn.innerHTML = 'GitHub に保存';
                saveToGitHubBtn.classList.remove('saving');
                saveToGitHubBtn.disabled = false;
            }, 2500);
        } catch(e) {
            saveToGitHubBtn.innerHTML = '&#x2716; エラー';
            saveToGitHubBtn.classList.remove('saving');
            saveToGitHubBtn.classList.add('error-state');
            showStatus(saveStatus, e.message, 'error');
            // Keep error visible longer for permission errors
            const delay = e.message.includes('権限') ? 15000 : 5000;
            setTimeout(() => {
                saveToGitHubBtn.innerHTML = 'GitHub に保存';
                saveToGitHubBtn.classList.remove('error-state');
                saveToGitHubBtn.disabled = false;
            }, delay);
        }
    }

    reloadBtn.addEventListener('click', async () => {
        if (hasUnsavedChanges && !confirm('未保存の変更があります。再読み込みすると失われますが、よろしいですか？')) return;
        reloadBtn.disabled = true;
        reloadBtn.textContent = '読み込み中...';
        try {
            await fetchBlogFromGitHub();
            render();
            showStatus(formStatus, 'GitHub から最新版を読み込みました（' + articles.length + ' 件）', 'success');
        } catch(e) {
            showStatus(formStatus, '再読み込みに失敗: ' + e.message, 'error');
        }
        reloadBtn.disabled = false;
        reloadBtn.textContent = '再読み込み';
    });

    logoutBtn.addEventListener('click', () => {
        if (hasUnsavedChanges && !confirm('未保存の変更があります。ログアウトしますか？')) return;
        sessionStorage.removeItem('blog_editor_session');
        ghToken = '';
        ghFileSha = '';
        articles = [];
        hasUnsavedChanges = false;
        editorScreen.classList.remove('active');
        loginScreen.classList.remove('hidden');
        loginToken.value = '';
        loginError.classList.remove('show');
    });

    copyBtn.addEventListener('click', () => {
        const text = generateFullHTML();
        navigator.clipboard.writeText(text).then(() => {
            showStatus(saveStatus, 'コピーしました', 'success');
        }).catch(() => {
            fallbackCopy(text);
            showStatus(saveStatus, 'コピーしました', 'success');
        });
    });

    dlBtn.addEventListener('click', () => {
        const html = generateFullHTML();
        const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'blog.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showStatus(saveStatus, 'ダウンロードしました', 'success');
    });

    // ===== CATEGORY PREVIEW =====
    categorySelect.addEventListener('change', () => {
        const v = categorySelect.value;
        catPreview.textContent = catLabels[v];
        catPreview.className = 'cat-preview ' + v;
    });

    // ===== ARTICLE CRUD =====
    addBtn.addEventListener('click', () => {
        const date = dateInput.value.trim();
        const title = titleInput.value.trim();
        if (!date || !title) { showStatus(formStatus, '日付とタイトルは必須です', 'info'); return; }
        articles.unshift({ date, category: categorySelect.value, title, content: contentInput.value.trim() });
        clearForm();
        markUnsaved();
        render();
        showStatus(formStatus, '記事を追加しました（まだ保存されていません）', 'success');
    });

    updateBtn.addEventListener('click', () => {
        if (editingIndex < 0) return;
        const date = dateInput.value.trim();
        const title = titleInput.value.trim();
        if (!date || !title) { showStatus(formStatus, '日付とタイトルは必須です', 'info'); return; }
        articles[editingIndex] = { date, category: categorySelect.value, title, content: contentInput.value.trim() };
        editingIndex = -1;
        clearForm();
        showEditMode(false);
        markUnsaved();
        render();
        showStatus(formStatus, '記事を更新しました（まだ保存されていません）', 'success');
    });

    cancelBtn.addEventListener('click', () => {
        editingIndex = -1;
        clearForm();
        showEditMode(false);
    });

    // ===== PARSE / GENERATE =====
    function parseExistingBlog(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const items = doc.querySelectorAll('.blog-item');
        articles = [];
        items.forEach(item => {
            articles.push({
                date: (item.querySelector('.blog-date') || {}).textContent?.trim() || '',
                category: item.getAttribute('data-category') || 'notice',
                title: (item.querySelector('.blog-title') || {}).textContent?.trim() || '',
                content: (item.querySelector('.blog-content-inner') || {}).innerHTML?.trim() || ''
            });
        });
    }

    function articleToHTML(a) {
        const cc = catClasses[a.category] || 'cat-notice';
        const cl = catLabels[a.category] || 'お知らせ';
        const I = '                    ';
        return [
            I + '<article class="blog-item" data-category="' + a.category + '">',
            I + '    <div class="blog-header">',
            I + '        <div class="blog-title-area">',
            I + '            <div class="blog-meta">',
            I + '                <span class="cat-badge ' + cc + '">' + cl + '</span>',
            I + '                <span class="blog-date">' + esc(a.date) + '</span>',
            I + '            </div>',
            I + '            <h3 class="blog-title">' + esc(a.title) + '</h3>',
            I + '        </div>',
            I + '        <div class="toggle-icon"></div>',
            I + '    </div>',
            I + '    <div class="blog-content">',
            I + '        <div class="blog-content-inner">',
            I + '        ' + (a.content || ''),
            I + '        </div>',
            I + '    </div>',
            I + '</article>'
        ].join('\n');
    }

    function generateFullHTML() {
        const body = articles.map(a => articleToHTML(a)).join('\n\n');
        return '<!DOCTYPE html>\n<html lang="ja">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>ブログ | 木村紀喜</title>\n    \n    <meta name="description" content="木村紀喜のブログ。教育について感じたこと、考えたこと、日々の活動記録。">\n    <meta property="og:title" content="ブログ | 木村紀喜">\n    <meta property="og:description" content="教育について感じたこと、考えたことを綴ります">\n    <meta property="og:type" content="article">\n    \n    <link rel="icon" href="favicon.ico" sizes="any">\n    <link rel="apple-touch-icon" href="apple-touch-icon.png">\n    \n    <link rel="preconnect" href="https://fonts.googleapis.com">\n    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;800&family=Outfit:wght@400;600&display=swap">\n    \n    <link rel="stylesheet" href="css/common.css">\n    <link rel="stylesheet" href="css/blog.css">\n</head>\n<body>\n    <header class="site-header">\n        <div class="header-inner">\n            <a href="index.html" class="logo">木村紀喜</a>\n            <button class="menu-toggle" id="menuToggle" aria-label="メニューを開く">\n                <span class="menu-icon"></span>\n            </button>\n            <nav id="navigation">\n                <ul>\n                    <li><a href="index.html">ホーム</a></li>\n                    <li><a href="profile.html">プロフィール</a></li>\n                    <li><a href="research.html">研究・活動</a></li>\n                    <li><a href="blog.html" class="current">ブログ</a></li>\n                    <li><a href="contact.html">お問い合わせ</a></li>\n                </ul>\n            </nav>\n        </div>\n    </header>\n\n    <main>\n        <section class="hero-base blog-hero">\n            <div class="hero-overlay"></div>\n            <div class="hero-content">\n                <div class="blog-intro">\n                    <h1 class="hero-title animate-fade-up delay-1">ブログ</h1>\n                    <p class="hero-subtitle animate-fade-up delay-2">日々の思考と実践の記録</p>\n                </div>\n            </div>\n        </section>\n\n        <div class="page-content">\n            <div class="blog-container scroll-animate">\n                \n                <div class="filter-container">\n                    <button class="filter-btn active" data-filter="all">すべて</button>\n                    <button class="filter-btn" data-filter="notice">お知らせ</button>\n                    <button class="filter-btn" data-filter="activity">活動</button>\n                    <button class="filter-btn" data-filter="thought">思考</button>\n                </div>\n\n                <div class="blog-posts">\n' + body + '\n                </div>\n            </div>\n        </div>\n    </main>\n\n    <footer class="site-footer">\n        <p>&copy; 2025 木村紀喜 (Toshiki Kimura). All Rights Reserved.<br>\n        当サイトは個人が運営しており、所属自治体・学校の公式見解ではありません。</p>\n    </footer>\n\n    <script src="js/main.js" defer></' + 'script>\n</body>\n</html>';
    }

    // ===== RENDER =====
    function render() { renderList(); renderOutput(); }

    function renderList() {
        articleCount.textContent = articles.length + '件';
        if (!articles.length) {
            articleList.innerHTML = '<p style="color:#999;font-size:0.86rem;">記事がありません。</p>';
            return;
        }
        articleList.innerHTML = articles.map((a, i) => {
            return '<div class="article-entry ' + (editingIndex === i ? 'selected' : '') + '">' +
                '<span class="entry-cat" style="background:' + (catColors[a.category]||'#999') + '">' + catLabels[a.category] + '</span>' +
                '<span class="entry-date">' + a.date + '</span>' +
                '<span class="entry-title">' + esc(a.title) + '</span>' +
                '<span class="entry-actions">' +
                (i > 0 ? '<button class="entry-btn up" data-a="up" data-i="'+i+'">&#x25B2;</button>' : '') +
                (i < articles.length-1 ? '<button class="entry-btn down" data-a="down" data-i="'+i+'">&#x25BC;</button>' : '') +
                '<button class="entry-btn edit" data-a="edit" data-i="'+i+'">編集</button>' +
                '<button class="entry-btn delete" data-a="delete" data-i="'+i+'">削除</button>' +
                '</span></div>';
        }).join('');

        articleList.querySelectorAll('.entry-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                e.stopPropagation();
                handleAction(btn.dataset.a, parseInt(btn.dataset.i));
            });
        });
    }

    function handleAction(action, idx) {
        if (action === 'edit') {
            editingIndex = idx;
            const a = articles[idx];
            dateInput.value = a.date;
            categorySelect.value = a.category;
            categorySelect.dispatchEvent(new Event('change'));
            titleInput.value = a.title;
            contentInput.value = a.content;
            showEditMode(true);
            renderList();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else if (action === 'delete') {
            if (!confirm('「' + articles[idx].title + '」を削除しますか？')) return;
            articles.splice(idx, 1);
            if (editingIndex === idx) { editingIndex = -1; clearForm(); showEditMode(false); }
            else if (editingIndex > idx) editingIndex--;
            markUnsaved();
            render();
        } else if (action === 'up' && idx > 0) {
            [articles[idx-1], articles[idx]] = [articles[idx], articles[idx-1]];
            if (editingIndex === idx) editingIndex--;
            else if (editingIndex === idx-1) editingIndex++;
            markUnsaved();
            render();
        } else if (action === 'down' && idx < articles.length-1) {
            [articles[idx], articles[idx+1]] = [articles[idx+1], articles[idx]];
            if (editingIndex === idx) editingIndex++;
            else if (editingIndex === idx+1) editingIndex--;
            markUnsaved();
            render();
        }
    }

    function renderOutput() {
        outputArea.textContent = articles.length ? generateFullHTML() : '<!-- 記事を追加してください -->';
    }

    // ===== HELPERS =====
    function clearForm() {
        const d = new Date();
        dateInput.value = d.getFullYear() + '.' + String(d.getMonth()+1).padStart(2,'0') + '.' + String(d.getDate()).padStart(2,'0');
        categorySelect.value = 'notice';
        categorySelect.dispatchEvent(new Event('change'));
        titleInput.value = '';
        contentInput.value = '';
    }

    function showEditMode(on) {
        addBtn.style.display = on ? 'none' : '';
        updateBtn.style.display = on ? '' : 'none';
        cancelBtn.style.display = on ? '' : 'none';
    }

    function showStatus(el, msg, type) {
        el.textContent = msg;
        el.className = 'status-msg show ' + type;
        // Keep error messages visible longer
        const duration = type === 'error' ? 15000 : 4000;
        setTimeout(() => el.classList.remove('show'), duration);
    }

    function markUnsaved() {
        hasUnsavedChanges = true;
        updateUnsavedBadge();
    }

    function updateUnsavedBadge() {
        unsavedBadge.classList.toggle('show', hasUnsavedChanges);
    }

    function esc(s) {
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    function fallbackCopy(text) {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.cssText = 'position:fixed;left:-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
    }

    // Warn before closing with unsaved changes
    window.addEventListener('beforeunload', e => {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

})();
</script>
</body>
</html>
